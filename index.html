<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>AR con Detección de Planos Reales</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-ar@1.7.0/dist/aframe-ar.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        #ar-prompt {
            position: absolute;
            bottom: 30px;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
            background-color: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 10px;
            margin: 0 20px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="ar-prompt">Toque para colocar el modelo en una superficie plana</div>
    
    <a-scene
        vr-mode-ui="enabled: false"
        xr-mode-ui="XRMode: immersive-ar"
        arjs="sourceType: webcam; debugUIEnabled: false;"
        renderer="logarithmicDepthBuffer: true; precision: high;">
        
        <a-assets>
            <a-asset-item id="model" src="model.glb"></a-asset-item>
        </a-assets>

        <!-- Entidad para el modelo que se colocará -->
        <a-entity id="model-entity" gltf-model="#model" scale="0.1 0.1 0.1" visible="false"></a-entity>
        
        <a-entity camera></a-entity>
    </a-scene>

    <script>
        let hitTestSource = null;
        let modelPlaced = false;
        const modelEntity = document.getElementById('model-entity');
        const arPrompt = document.getElementById('ar-prompt');
        
        // Verificar soporte para WebXR AR
        async function checkXRSupport() {
            if (!navigator.xr) {
                arPrompt.textContent = "AR no es compatible con tu dispositivo";
                return false;
            }
            
            try {
                const supported = await navigator.xr.isSessionSupported('immersive-ar');
                if (!supported) {
                    arPrompt.textContent = "AR no está disponible. Intenta con un dispositivo Android compatible con ARCore";
                    return false;
                }
                return true;
            } catch (error) {
                console.error("Error checking XR support:", error);
                return false;
            }
        }
        
        // Iniciar sesión AR
        async function startAR() {
            const sceneEl = document.querySelector('a-scene');
            const xrSession = await sceneEl.xrSession;
            
            // Configurar hit test para detección de planos
            const space = await xrSession.requestReferenceSpace('viewer');
            hitTestSource = await xrSession.requestHitTestSource({ space });
            
            // Manejar clics para colocar modelo
            sceneEl.addEventListener('click', (evt) => {
                if (modelPlaced || !hitTestSource) return;
                
                const frame = evt.detail.frame;
                const hitTestResults = frame.getHitTestResults(hitTestSource);
                
                if (hitTestResults.length > 0) {
                    const pose = hitTestResults[0].getPose(space);
                    
                    modelEntity.setAttribute('position', {
                        x: pose.transform.position.x,
                        y: pose.transform.position.y,
                        z: pose.transform.position.z
                    });
                    
                    modelEntity.setAttribute('visible', 'true');
                    modelEntity.setAttribute('animation', {
                        property: 'scale',
                        from: '0.01 0.01 0.01',
                        to: '0.1 0.1 0.1',
                        dur: 1000,
                        easing: 'easeOutElastic'
                    });
                    
                    modelPlaced = true;
                    arPrompt.style.display = 'none';
                }
            });
        }
        
        // Inicializar
        (async function() {
            const supported = await checkXRSupport();
            if (supported) {
                arPrompt.textContent = "Mueve el dispositivo para detectar superficies planas";
                startAR();
            }
        })();
    </script>
</body>
</html>
