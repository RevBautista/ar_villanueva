<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Prueba AR - Diagn√≥stico</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.jsdelivr.net/npm/aframe@1.4.2/dist/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.0/dist/mindar-image-aframe.prod.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: Arial, sans-serif;
        }
        #status {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            padding: 10px;
            background-color: rgba(0,0,0,0.8);
            color: white;
            border-radius: 5px;
            z-index: 1000;
            font-size: 14px;
        }
        #debug {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            padding: 10px;
            background-color: rgba(0,0,0,0.7);
            color: #0f0;
            font-family: monospace;
            font-size: 12px;
            z-index: 1000;
            max-height: 30%;
            overflow: auto;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="status">üîÑ Inicializando AR...</div>
    <div id="debug">Consola de diagn√≥stico:</div>

    <a-scene 
        mindar-image="imageTargetSrc: target.mind; uiLoading: no; uiScanning: no; uiError: no;"
        vr-mode-ui="enabled: false"
        loading-screen="enabled: false">

        <a-entity camera></a-entity>

        <!-- Marcador de prueba -->
        <a-entity mindar-image-target="targetIndex: 0">
            <a-box color="red" scale="0.2 0.2 0.2"></a-box>
        </a-entity>
    </a-scene>

    <script>
        const sceneEl = document.querySelector('a-scene');
        const statusEl = document.getElementById('status');
        const debugEl = document.getElementById('debug');
        
        // Variables de diagn√≥stico
        let loadStartTime = Date.now();
        let mindarReady = false;
        let cameraAllowed = false;

        // Funci√≥n para agregar mensajes de diagn√≥stico
        function logDebug(message) {
            const now = ((Date.now() - loadStartTime) / 1000).toFixed(2);
            debugEl.innerHTML += `[${now}s] ${message}<br>`;
            debugEl.scrollTop = debugEl.scrollHeight;
        }

        // Verificar compatibilidad
        function checkCompatibility() {
            const compatible = !!window.WebGLRenderingContext && 
                              !!document.createElement('canvas').getContext('webgl') &&
                              navigator.mediaDevices &&
                              navigator.mediaDevices.getUserMedia;
            
            if (!compatible) {
                statusEl.innerHTML = "‚ùå Dispositivo no compatible<br>" +
                                   "Necesitas un navegador moderno con WebGL y c√°mara";
                logDebug("ERROR: Navegador no compatible con WebGL/WebRTC");
            }
            return compatible;
        }

        // Verificar permisos de c√°mara
        async function checkCameraPermissions() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                stream.getTracks().forEach(track => track.stop());
                cameraAllowed = true;
                logDebug("Permisos de c√°mara: concedidos");
            } catch (err) {
                statusEl.innerHTML = "‚ùå Error de c√°mara<br>" +
                                   "Por favor permite acceso a la c√°mara y recarga";
                logDebug(`ERROR C√°mara: ${err.message}`);
                return false;
            }
            return true;
        }

        // Verificar carga de target.mind
        async function checkTargetFile() {
            try {
                const response = await fetch('target.mind');
                if (!response.ok) throw new Error("Archivo no encontrado");
                
                const content = await response.blob();
                logDebug(`target.mind cargado (${(content.size/1024).toFixed(1)}KB)`);
                return true;
            } catch (err) {
                statusEl.innerHTML = "‚ùå Error en target.mind<br>" +
                                   "Aseg√∫rate de que el archivo existe";
                logDebug(`ERROR target.mind: ${err.message}`);
                return false;
            }
        }

        // Inicializaci√≥n completa
        async function initializeAR() {
            if (!checkCompatibility()) return;
            
            logDebug("Iniciando diagn√≥stico...");
            
            // Verificar permisos y archivo en paralelo
            const [permissionsOk, targetOk] = await Promise.all([
                checkCameraPermissions(),
                checkTargetFile()
            ]);
            
            if (!permissionsOk || !targetOk) return;
            
            logDebug("Sistema compatible - Esperando MindAR...");
            
            // Configurar eventos de MindAR
            sceneEl.addEventListener('mindar-image-ready', (e) => {
                mindarReady = true;
                statusEl.innerHTML = "‚úÖ AR Listo<br>Busca el marcador";
                logDebug("MindAR inicializado correctamente");
                
                // Mostrar informaci√≥n de los targets
                const mindarSystem = sceneEl.systems["mindar-image-system"];
                if (mindarSystem && mindarSystem.imageTargets) {
                    logDebug(`Targets cargados: ${mindarSystem.imageTargets.length}`);
                }
            });
            
            sceneEl.addEventListener('targetFound', (e) => {
                statusEl.innerHTML = "üéØ Marcador detectado!";
                logDebug(`Target encontrado: ${e.detail.targetIndex}`);
            });
            
            sceneEl.addEventListener('targetLost', (e) => {
                statusEl.innerHTML = "üîç Buscando marcador...";
            });
            
            sceneEl.addEventListener('mindar-image-error', (e) => {
                statusEl.innerHTML = "‚ö†Ô∏è Error en AR";
                logDebug(`ERROR MindAR: ${e.detail.message}`);
            });
            
            // Timeout por si falla la inicializaci√≥n
            setTimeout(() => {
                if (!mindarReady) {
                    statusEl.innerHTML = "‚ö†Ô∏è AR no responde<br>" +
                                      "Intenta recargar la p√°gina";
                    logDebug("ERROR: Timeout de inicializaci√≥n");
                }
            }, 15000);
        }

        // Iniciar todo cuando el DOM est√© listo
        if (document.readyState === 'complete') {
            initializeAR();
        } else {
            window.addEventListener('load', initializeAR);
        }
    </script>
</body>
</html>
